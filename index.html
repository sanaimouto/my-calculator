<script>
    // === 核心功能區塊 ===

    // 當 DOM 內容加載完成時，執行初始化
    document.addEventListener('DOMContentLoaded', () => {
        loadRate();
        updatePricingFields();
        setupEnterKeyBindings();
    });

    // === Tab 切換邏輯 (無更動) ===
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        const index = ['pricing', 'link', 'calc', 'memo'].indexOf(tabId);
        document.querySelectorAll('.tab-btn')[index].classList.add('active');
    }

    // === 1. 定價計算器邏輯 ===
    
    // 設置 Enter 鍵綁定 (無更動)
    function setupEnterKeyBindings() {
        const inputs = ['jpyInput', 'jpShipInput', 'rateInput', 'shipInput'];
        inputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        calculatePrice();
                        
                        const currentIndex = inputs.indexOf(id);
                        const nextIndex = currentIndex + 1;
                        if (nextIndex < inputs.length) {
                            const nextElement = document.getElementById(inputs[nextIndex]);
                            if (nextElement) {
                                nextElement.focus();
                            }
                        } else {
                            document.getElementById(inputs[0]).focus();
                        }
                    }
                });
            }
        });
    }

    // 安全的數學運算評估 (無更動)
    function evalExpr(expr) {
        if (!expr) return 0;
        expr = expr.replace(/×/g, '*').replace(/÷/g, '/');
        if (/^[\d\.\+\-\*/\(\)\s]+$/.test(expr)) {
            try {
                return Function('"use strict";return (' + expr + ')')();
            } catch (e) {
                return 0;
            }
        }
        return 0;
    }

    // 更新欄位顯示邏輯
    function updatePricingFields() {
        const mode = parseInt(document.getElementById('modeSelector').value);
        
        // jpShipGroup (日本國內運費) 只有通販模式需要
        document.getElementById('jpShipGroup').style.display = (mode === 0) ? 'block' : 'none';
        
        // rateGroup (匯率): 適用於 Mode 0, Mode 2, Mode 3。 Mode 1 隱藏。
        const showRate = (mode === 0 || mode === 2 || mode === 3);
        document.getElementById('rateGroup').style.display = showRate ? 'block' : 'none';
        
        // shipGroup (國際運費) 只有通販和會場代購模式需要
        const showShip = (mode === 0 || mode === 3);
        document.getElementById('shipGroup').style.display = showShip ? 'block' : 'none';

        // 調整 Rate 欄位的 Placeholder 提示 (只在顯示時才需要)
        const rateInput = document.getElementById('rateInput');
        if (mode === 2) { 
            rateInput.placeholder = "請輸入含利潤的匯率/係數 (e.g., 0.23)";
        } else {
            rateInput.placeholder = "目前匯率 (e.g., 4.5)";
        }
    }

    function loadRate() {
        const savedRate = localStorage.getItem('tool_last_rate');
        if (savedRate) document.getElementById('rateInput').value = savedRate;
    }

    // 計算邏輯：Mode 1 已還原，Mode 2 維持動態匯率
    function calculatePrice() {
        const mode = parseInt(document.getElementById('modeSelector').value);
        const jpy = evalExpr(document.getElementById('jpyInput').value);
        const jpShip = evalExpr(document.getElementById('jpShipInput').value);
        const rate = evalExpr(document.getElementById('rateInput').value);
        const ship = evalExpr(document.getElementById('shipInput').value);

        let result = 0;
        let rateDisplay = ''; 

        if (mode === 0) { // 通販
            localStorage.setItem('tool_last_rate', rate);
            result = ((jpy + jpShip) * rate + ship) / 0.8;
            rateDisplay = `@匯率${rate}`;
        } else if (mode === 1) { // 中堅CD - 已還原為固定公式
            let base = 0;
            if (jpy >= 1 && jpy <= 3999) {
                base = jpy * 1.05 * 0.27 + 50; 
                base += (base <= 1000) ? 50 : 100;
            } else if (jpy >= 4000 && jpy <= 7999) {
                base = jpy * 1.05 * 0.26 + 50;
                base += (base <= 1999) ? 100 : 200;
            } else if (jpy >= 8000 && jpy <= 11999) {
                base = jpy * 1.05 * 0.25 + 50;
                base += (base <= 2999) ? 200 : 300;
            } else {
                base = jpy * 1.05 * 0.245 + 50;
                if (base <= 3999) base += 300;
                else if (base <= 4999) base += 400;
                else if (base <= 5999) base += 500;
                else if (base <= 6999) base += 600;
                else base += 700;
            }
            result = base / 0.95;
            rateDisplay = `[固定係數]`;
        } else if (mode === 2) { // 中堅船版書籍 - 維持動態匯率
            localStorage.setItem('tool_last_rate', rate);
            
            // 實作使用者確認的公式：商品本體 * 1.05 * 自填匯率/係數
            let base = jpy * 1.05 * rate; 
            
            // 加入固定費用/利潤
            if (base <= 1000) base += 50;
            else if (base <= 1999) base += 100;
            else if (base <= 2999) base += 200;
            else if (base <= 3999) base += 300;
            else base += 400;
            
            // 最後除以 0.95 (賣場 5% 手續費)
            result = base / 0.95;
            rateDisplay = `@係數${rate}`;
        } else if (mode === 3) { // 會場代購
            localStorage.setItem('tool_last_rate', rate);
            result = (jpy * 1.15 * rate + ship) / 0.8;
            rateDisplay = `@匯率${rate}`;
        }

        const final = result.toFixed(2);
        document.getElementById('priceResult').innerText = `建議售價：NT$ ${final}`;
        
        // Add to history
        const modeName = document.getElementById('modeSelector').options[mode].text;
        const historyItem = document.createElement('li');
        historyItem.innerText = `[${modeName}] 售價：${document.getElementById('jpyInput').value} ${rateDisplay} → NT$${final}`;
        const list = document.getElementById('pricingHistory');
        list.insertBefore(historyItem, list.firstChild);
    }

    function clearPricingInputs() {
        document.getElementById('jpyInput').value = '';
        document.getElementById('jpShipInput').value = '';
        document.getElementById('shipInput').value = '';
        document.getElementById('priceResult').innerText = '建議售價：';
    }

    function clearHistory() {
        document.getElementById('pricingHistory').innerHTML = '';
    }

    // === 2. 外連轉換器邏輯 (無更動) ===
    async function pasteFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('linkInput').value = text;
            convertLink();
        } catch (err) {
            alert('無法讀取剪貼簿，請手動貼上');
        }
    }

    function convertLink() {
        const raw = document.getElementById('linkInput').value.trim();
        let fileId = "";
        
        if (raw.includes("drive.google.com")) {
            const match1 = raw.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            const match2 = raw.match(/id=([a-zA-Z0-9_-]+)/);
            if (match1) fileId = match1[1];
            else if (match2) fileId = match2[1];
        }

        const output = document.getElementById('linkOutput');
        const copyBtn = document.getElementById('copyLinkBtn');

        if (fileId) {
            output.value = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1366`;
            copyBtn.disabled = false;
        } else {
            output.value = "❌ 格式錯誤，請確認是否為圖片分享連結";
            copyBtn.disabled = true;
        }
    }

    function copyLink() {
        const copyText = document.getElementById("linkOutput");
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        navigator.clipboard.writeText(copyText.value);
        const btn = document.getElementById('copyLinkBtn');
        const originalText = btn.innerText;
        btn.innerText = "✅ 已複製";
        setTimeout(() => btn.innerText = originalText, 1500);
    }

    // === 3. 計算機邏輯 (修正了 eval 錯誤) ===
    let calcExpr = "";
    let calcLastRes = "";

    function calcInput(key) {
        const display = document.getElementById('calcResult');
        const exprDisplay = document.getElementById('calcExpr');

        if (key === 'AC') {
            calcExpr = "";
            calcLastRes = "";
            display.innerText = "0";
            exprDisplay.innerText = "";
        } else if (key === 'DEL') {
            calcExpr = calcExpr.slice(0, -1);
            display.innerText = calcExpr || "0";
        } else if (key === '=') {
            try {
                if (calcLastRes && !/^[\d\.]/.test(calcExpr)) {
                   calcExpr = calcLastRes + calcExpr;
                }
                
                // 【已修正】將顯示用的 × 和 ÷ 轉換回程式碼可識別的 * 和 /
                let exprToEvaluate = calcExpr.replace(/×/g, '*').replace(/÷/g, '/');
                const result = eval(exprToEvaluate);
                
                calcLastRes = result.toString();
                display.innerText = result;
                exprDisplay.innerText = calcExpr + " =";
                calcExpr = "";
            } catch {
                display.innerText = "Error";
                calcExpr = "";
            }
        } else {
            if (['+','-','*','/'].includes(key) && calcExpr === "" && calcLastRes !== "") {
                calcExpr = calcLastRes;
            }
            calcExpr += key;
            display.innerText = calcExpr;
        }
    }
    
    // 鍵盤支援 (維持不變，繼續將 * / 轉換為 × ÷ 供顯示)
    document.addEventListener('keydown', function(event) {
        if (!document.getElementById('calc').classList.contains('active')) return;
        
        const key = event.key;
        if (/[0-9\.\+\-\*\/\(\)]/.test(key)) {
            // 注意：這裡將 * / 轉換為 × ÷ 是為了美觀顯示，計算時會再次轉換回去
            calcInput(key.replace('*','×').replace('/','÷'));
        } else if (key === 'Enter') {
            calcInput('=');
            event.preventDefault();
        } else if (key === 'Backspace') {
            calcInput('DEL');
        } else if (key === 'Escape') {
            calcInput('AC');
        }
    });

    // === 4. 記事本邏輯 (無更動) ===
    const memoArea = document.getElementById('memoArea');
    
    if (localStorage.getItem('tool_memo')) {
        memoArea.value = localStorage.getItem('tool_memo');
    }

    memoArea.addEventListener('input', function() {
        localStorage.setItem('tool_memo', this.value);
    });

    function clearMemo() {
        if(confirm('確定要清空記事嗎？')) {
            memoArea.value = '';
            localStorage.removeItem('tool_memo');
        }
    }

    // === 5. 獨立視窗邏輯 (無更動) ===
    function openPopup() {
        window.open(window.location.href, "ToolsPopup", "menubar=no,toolbar=no,location=no,status=no");
    }
</script>
